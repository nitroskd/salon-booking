<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>å•†å“ä¸€è¦§ | Salon Coeur</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: #fefbf5;
      color: #444;
      padding: 15px;
      padding-bottom: 40px;
    }

    .header {
      text-align: center;
      margin-bottom: 25px;
    }

    .logo {
      font-size: 2em;
      margin-bottom: 10px;
    }

    h1 {
      color: #6a8f66;
      font-size: 1.6em;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #888;
      font-size: 0.9em;
      font-weight: 300;
    }

    .back-link {
      display: inline-block;
      margin: 15px auto 20px;
      padding: 10px 20px;
      background: #a3b18a;
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-size: 0.9em;
      transition: 0.3s;
    }

    .back-link:active {
      transform: scale(0.98);
    }

    .filter-section {
      margin: 20px 0;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .filter-label {
      font-size: 0.85em;
      color: #666;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
      padding: 5px 0;
      white-space: nowrap;
      margin-bottom: 15px;
    }

    .filter-btn {
      padding: 10px 20px;
      background: #ffffff;
      border: 2px solid #d9d6ce;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
      font-size: 0.9em;
      color: #666;
      font-family: 'Noto Sans JP', sans-serif;
      flex-shrink: 0;
      touch-action: manipulation;
    }

    .filter-btn.active {
      background: #a3b18a;
      color: white;
      border-color: #a3b18a;
    }

    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .product-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
      transition: 0.3s;
      position: relative;
    }

    .product-card:active {
      transform: scale(0.98);
    }

    .sale-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #ff4757;
      color: white;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 600;
      z-index: 1;
      box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
    }

    .product-image {
      width: 100%;
      height: 160px;
      background: linear-gradient(135deg, #e8e4dc 0%, #d9d6ce 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5em;
      color: #a3b18a;
    }

    .product-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-info {
      padding: 15px;
    }

    .product-badges {
      display: flex;
      gap: 5px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .product-category {
      display: inline-block;
      padding: 3px 10px;
      background: #f0ede5;
      color: #6a8f66;
      border-radius: 10px;
      font-size: 0.75em;
    }

    .product-brand {
      display: inline-block;
      padding: 3px 10px;
      background: #e8f5e9;
      color: #4caf50;
      border-radius: 10px;
      font-size: 0.75em;
    }

    .product-name {
      font-size: 1em;
      font-weight: 500;
      color: #333;
      margin: 8px 0;
      line-height: 1.4;
    }

    .product-description {
      color: #777;
      font-size: 0.85em;
      line-height: 1.5;
      margin: 8px 0;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .product-price-section {
      margin: 10px 0 5px;
    }

    .original-price {
      font-size: 0.9em;
      color: #999;
      text-decoration: line-through;
      margin-bottom: 3px;
    }

    .product-price {
      font-size: 1.3em;
      color: #6a8f66;
      font-weight: 600;
    }

    .sale-price {
      color: #ff4757;
    }

    .stock-info {
      font-size: 0.8em;
      color: #999;
    }

    .stock-info.in-stock {
      color: #6a8f66;
    }

    .stock-info.low-stock {
      color: #d4a574;
    }

    .stock-info.out-of-stock {
      color: #c66;
    }

    .loading, .error, .no-products {
      text-align: center;
      padding: 40px 20px;
      color: #999;
      font-size: 1em;
    }

    footer {
      text-align: center;
      margin-top: 30px;
      color: #888;
      font-size: 0.85em;
    }

    @media (max-width: 480px) {
      .products-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
      }

      .product-image {
        height: 140px;
        font-size: 2em;
      }

      .product-info {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">ğŸŒ¿</div>
    <h1>å•†å“ä¸€è¦§</h1>
    <p class="subtitle">ã‚µãƒ­ãƒ³å³é¸å•†å“</p>
    <div class="note">
        å•†å“è³¼å…¥ã¯ã”æ¥åº—ã®ãŠå®¢æ§˜ã®ã¿ã®è²©å£²ã¨ãªã‚Šã¾ã™ã€‚
      </div>
    <a href="/home" class="back-link">â† ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
  </div>

  <div class="filter-section">
    <div class="filter-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</div>
    <div class="filter-buttons" id="category-filters">
      <button class="filter-btn active" data-category="all">ã™ã¹ã¦</button>
    </div>
    
    <div class="filter-label" style="margin-top: 15px;">ãƒ–ãƒ©ãƒ³ãƒ‰</div>
    <div class="filter-buttons" id="brand-filters">
      <button class="filter-btn active" data-brand="all">ã™ã¹ã¦</button>
    </div>
  </div>

  <div id="products-container">
    <div class="loading">å•†å“ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <footer>
    <p>Â© 2025 Salon Coeur</p>
  </footer>

  <script>
    let allProducts = [];
    let categories = [];
    let brands = [];
    let currentCategory = 'all';
    let currentBrand = 'all';

    async function fetchCategories() {
      try {
        const response = await fetch('/categories');
        const data = await response.json();
        categories = data.categories || [];
        renderCategoryFilters();
      } catch (error) {
        console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    async function fetchBrands() {
      try {
        const response = await fetch('/brands');
        const data = await response.json();
        brands = data.brands || [];
        renderBrandFilters();
      } catch (error) {
        console.error('ãƒ–ãƒ©ãƒ³ãƒ‰å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    async function fetchProducts() {
      try {
        const response = await fetch('/products');
        const data = await response.json();
        allProducts = data.products || [];
        displayProducts(allProducts);
      } catch (error) {
        document.getElementById('products-container').innerHTML = 
          '<div class="error">å•†å“ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }

    function renderCategoryFilters() {
      const container = document.getElementById('category-filters');
      const allBtn = '<button class="filter-btn active" data-category="all">ã™ã¹ã¦</button>';
      const categoryBtns = categories.map(cat => 
        `<button class="filter-btn" data-category="${cat.category_name}">${cat.category_name}</button>`
      ).join('');
      container.innerHTML = allBtn + categoryBtns;
      
      container.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          filterByCategory(btn.dataset.category);
        });
      });
    }

    function renderBrandFilters() {
      const container = document.getElementById('brand-filters');
      const allBtn = '<button class="filter-btn active" data-brand="all">ã™ã¹ã¦</button>';
      const brandBtns = brands.map(brand => 
        `<button class="filter-btn" data-brand="${brand.brand_name}">${brand.brand_name}</button>`
      ).join('');
      container.innerHTML = allBtn + brandBtns;
      
      container.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          filterByBrand(btn.dataset.brand);
        });
      });
    }

    function calculateDiscount(originalPrice, salePrice) {
      if (!originalPrice || originalPrice <= salePrice) return 0;
      return Math.round(((originalPrice - salePrice) / originalPrice) * 100);
    }

    function displayProducts(products) {
      const container = document.getElementById('products-container');
      
      if (!products || products.length === 0) {
        container.innerHTML = '<div class="no-products">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      const html = '<div class="products-grid">' + 
        products.map(product => {
          const stockClass = product.stock_quantity > 10 ? 'in-stock' : 
                           product.stock_quantity > 0 ? 'low-stock' : 'out-of-stock';
          const stockText = product.stock_quantity > 0 ? 
                          `åœ¨åº«: ${product.stock_quantity}å€‹` : 'åœ¨åº«åˆ‡ã‚Œ';
          
          const imageHtml = product.image_data ? 
            `<img src="${product.image_data}" alt="${product.product_name}">` :
            'ğŸŒ¿';
          
          const hasDiscount = product.original_price && product.original_price > product.price;
          const discountPercent = hasDiscount ? calculateDiscount(product.original_price, product.price) : 0;
          
          const saleBadge = hasDiscount ? `<div class="sale-badge">${discountPercent}% OFF</div>` : '';
          
          const priceHtml = hasDiscount ? `
            <div class="original-price">Â¥${Number(product.original_price).toLocaleString()}</div>
            <div class="product-price sale-price">Â¥${Number(product.price).toLocaleString()}</div>
          ` : `
            <div class="product-price">Â¥${Number(product.price).toLocaleString()}</div>
          `;
          
          const badges = [];
          if (product.category) {
            badges.push(`<span class="product-category">${product.category}</span>`);
          }
          if (product.brand) {
            badges.push(`<span class="product-brand">${product.brand}</span>`);
          }
          
          return `
            <div class="product-card">
              ${saleBadge}
              <div class="product-image">${imageHtml}</div>
              <div class="product-info">
                <div class="product-badges">${badges.join('')}</div>
                <div class="product-name">${product.product_name}</div>
                <div class="product-description">${product.description || ''}</div>
                <div class="product-price-section">${priceHtml}</div>
                <div class="stock-info ${stockClass}">${stockText}</div>
              </div>
            </div>
          `;
        }).join('') + '</div>';
      
      container.innerHTML = html;
    }

    function filterByCategory(category) {
      currentCategory = category;
      document.querySelectorAll('#category-filters .filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.category === category) {
          btn.classList.add('active');
        }
      });
      applyFilters();
    }

    function filterByBrand(brand) {
      currentBrand = brand;
      document.querySelectorAll('#brand-filters .filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.brand === brand) {
          btn.classList.add('active');
        }
      });
      applyFilters();
    }

    function applyFilters() {
      let filtered = allProducts;
      
      if (currentCategory !== 'all') {
        filtered = filtered.filter(p => p.category === currentCategory);
      }
      
      if (currentBrand !== 'all') {
        filtered = filtered.filter(p => p.brand === currentBrand);
      }
      
      displayProducts(filtered);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await fetchCategories();
      await fetchBrands();
      await fetchProducts();
    });
  </script>
</body>
</html>